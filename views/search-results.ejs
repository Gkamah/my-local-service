<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        .profile-pic-small {
            width: 50px;
            height: 50px;
            object-fit: cover;
        }
        .profile-pic-large {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border: 3px solid white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        /* Custom scrollbar for provider list */
        .provider-list::-webkit-scrollbar {
            width: 6px;
        }
        .provider-list::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 3px;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <!-- Navigation Bar -->
    <nav class="bg-gray-800 text-white p-4 shadow-lg sticky top-0 z-10">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <a href="/" class="text-2xl font-bold hover:text-indigo-400 transition">Local Service Finder</a>
            <div class="flex space-x-4">
                <% if (isLoggedIn) { %>
                    <a href="/provider/profile" class="hover:text-indigo-400 transition">Dashboard</a>
                    <a href="/logout" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-lg font-medium transition">Logout</a>
                <% } else { %>
                    <a href="/login" class="hover:text-indigo-400 transition">Provider Login</a>
                    <a href="/register" class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1 rounded-lg font-medium transition">Register</a>
                <% } %>
            </div>
        </div>
    </nav>

    <main class="flex-grow p-4 md:p-8 max-w-7xl mx-auto w-full">
        <h1 class="text-3xl font-extrabold text-gray-900 mb-6">Find Local Service Providers</h1>

        <!-- Search Form -->
        <form action="/search" method="GET" class="mb-8 p-4 bg-white rounded-xl shadow-lg flex flex-col md:flex-row gap-4">
            <input type="text" name="query" placeholder="Search by name or keyword..." value="<%= query %>"
                   class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition">
            
            <select name="category" class="p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition">
                <option value="All Categories" <%= selectedCategory === 'All Categories' ? 'selected' : '' %>>All Categories</option>
                <% uniqueCategories.forEach(cat => { %>
                    <option value="<%= cat %>" <%= selectedCategory === cat ? 'selected' : '' %>>
                        <%= cat %>
                    </option>
                <% }) %>
            </select>
            
            <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-lg transition shadow-md">
                Search
            </button>
        </form>

        <!-- Main Content Grid: Results List and Detail Panel -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            
            <!-- 1. Search Results List (Left Column) -->
            <div class="md:col-span-2 space-y-4 provider-list max-h-[80vh] overflow-y-auto">
                <% if (providers.length === 0) { %>
                    <div class="p-6 bg-yellow-100 border border-yellow-300 text-yellow-800 rounded-xl text-center shadow-md">
                        <p class="font-semibold">No service providers found matching your criteria.</p>
                        <p class="text-sm mt-1">Try broadening your search terms or selecting 'All Categories'.</p>
                    </div>
                <% } else { %>
                    <% providers.forEach(provider => { %>
                        <!-- Provider Card - Clickable Element -->
                        <div 
                            class="provider-card bg-white p-4 rounded-xl shadow-md border-l-4 border-indigo-500 hover:shadow-lg hover:bg-indigo-50 transition cursor-pointer flex items-center space-x-4"
                            onclick="viewDetails('<%= provider._id %>')">
                            
                            <% 
                                const defaultImage = 'https://placehold.co/50x50/5B5E63/ffffff?text=' + encodeURIComponent(provider.name.charAt(0).toUpperCase());
                                // Small image logic: Ensure Base64 prefix is used
                                let smallImageUrl = defaultImage;
                                if (provider.profilePictureUrl && typeof provider.profilePictureUrl === 'string' && provider.profilePictureUrl.length > 0) {
                                    smallImageUrl = provider.profilePictureUrl.startsWith('data:image') 
                                        ? provider.profilePictureUrl 
                                        : `data:image/png;base64,${provider.profilePictureUrl}`;
                                }
                            %>
                            <img src="<%= smallImageUrl %>" alt="<%= provider.name %>" 
                                class="profile-pic-small rounded-full flex-shrink-0"
                                onerror="this.onerror=null;this.src='<%= defaultImage %>';">
                            
                            <div class="flex-grow">
                                <h2 class="text-xl font-bold text-gray-900"><%= provider.name %></h2>
                                <p class="text-indigo-600 font-medium"><%= provider.category %></p>
                                <!-- Description: ensuring visibility -->
                                <p class="text-gray-500 text-sm truncate"><%= provider.description || 'No description provided.' %></p>
                            </div>
                        </div>
                    <% }); %>
                <% } %>
            </div>

            <!-- 2. Detail Panel (Right Column - Dynamic View) -->
            <div class="md:col-span-1 bg-white p-6 rounded-xl shadow-2xl sticky top-24 max-h-[80vh] overflow-y-auto" id="provider-details">
                <div class="text-center py-12 text-gray-500">
                    <svg class="w-16 h-16 mx-auto mb-4 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 15l-2 5L9 9l11 4-5 2zm0 0l-2 5L9 9l11 4-5 2zm0 0l-2 5L9 9l11 4-5 2z"></path></svg>
                    <p class="font-semibold">Click a provider on the left to view their full profile details here.</p>
                </div>
            </div>

        </div>
    </main>

    <script>
        // Data passed from the server and safely converted to a JavaScript array
        // FIX: The data is now wrapped in JSON.parse to prevent 'Unexpected token <' 
        // by ensuring the EJS output is strictly treated as a string literal.
        const providersData = JSON.parse('<%- JSON.stringify(providers || []) %>');
        const detailsContainer = document.getElementById('provider-details');
        
        // Converts Base64 data to a safe image URL or provides a default placeholder
        function getImageUrl(provider) {
            const nameInitial = provider.name.charAt(0).toUpperCase();
            const defaultImage = `https://placehold.co/100x100/5B5E63/ffffff?text=${nameInitial}`;
            
            const imageData = provider.profilePictureUrl;

            // FIX: Robust check for image data presence and formatting
            if (typeof imageData === 'string' && imageData.length > 0) {
                // If the string starts with 'data:image', it's already a full data URI.
                if (imageData.startsWith('data:image')) {
                    return imageData;
                }
                // Otherwise, assume it is a raw Base64 string and prefix it.
                return `data:image/png;base64,${imageData}`;
            }

            return defaultImage;
        }


        // Function to load details into the right panel
        function viewDetails(providerId) {
            const provider = providersData.find(p => p._id === providerId);
            
            if (!provider) {
                detailsContainer.innerHTML = `<div class="p-6 text-center text-red-500">Provider data error.</div>`;
                return;
            }
            
            const imageUrl = getImageUrl(provider);
            const isSubscribed = provider.isSubscribed;

            // Organized HTML template for the side panel
            detailsContainer.innerHTML = `
                <div class="relative text-center pb-4">
                    <div class="w-full bg-indigo-100 h-20 rounded-t-xl"></div>
                    <img src="${imageUrl}" alt="${provider.name}" 
                         class="profile-pic-large rounded-full mx-auto -mt-12 relative"
                         onerror="this.onerror=null;this.src='${getImageUrl({name: provider.name})}';">
                </div>

                <div class="text-center pt-4 border-b pb-4 mb-4">
                    <h2 class="text-3xl font-extrabold text-gray-900">${provider.name}</h2>
                    <p class="text-xl font-semibold text-indigo-600">${provider.category}</p>
                    ${isSubscribed ? `
                        <span class="inline-flex items-center px-3 py-1 mt-2 rounded-full text-xs font-medium bg-green-100 text-green-800 shadow-sm">
                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            Verified & Subscribed
                        </span>
                    ` : ''}
                </div>

                <!-- About Card -->
                <div class="space-y-4">
                    <div class="bg-gray-50 p-4 rounded-lg shadow-inner">
                        <h3 class="text-lg font-bold text-gray-800 mb-2 flex items-center">
                            <svg class="w-5 h-5 text-indigo-500 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2v-3m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                            Description
                        </h3>
                        <p class="text-gray-600 text-sm leading-relaxed">${provider.description || 'No detailed description provided yet.'}</p>
                    </div>

                    <!-- Contact Card -->
                    <div class="bg-gray-50 p-4 rounded-lg shadow-inner">
                        <h3 class="text-lg font-bold text-gray-800 mb-2 flex items-center">
                            <svg class="w-5 h-5 text-indigo-500 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path></svg>
                            Contact
                        </h3>
                        <ul class="text-sm space-y-2">
                            <li><span class="font-medium">Email:</span> <a href="mailto:${provider.email}" class="text-indigo-600 hover:text-indigo-800">${provider.email}</a></li>
                            <li><span class="font-medium">Phone:</span> ${provider.contactInfo || 'Not Provided'}</li>
                        </ul>
                    </div>
                </div>

                <!-- Call to Action -->
                <div class="mt-6 text-center">
                    <a href="mailto:${provider.email}" class="inline-block w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition transform hover:scale-[1.02]">
                        Book Service Now
                    </a>
                </div>
            `;
        }

        // Auto-select the first provider if available
        document.addEventListener('DOMContentLoaded', () => {
            if (providersData.length > 0) {
                viewDetails(providersData[0]._id);
            }
        });
    </script>
</body>
</html>

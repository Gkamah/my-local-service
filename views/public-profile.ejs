<%- include('./partials/head', { title: title }) %>

<style>
    /* Styling for the Profile Editor */
    .editor-container {
        max-width: 800px;
        margin: 3rem auto;
        padding: 0 1rem;
    }
    .profile-photo-preview {
        width: 150px;
        height: 150px;
        border-radius: 50%;
        background-color: #434375;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 50px;
        color: white;
        margin: 1rem auto;
        overflow: hidden;
        border: 5px solid #fff;
        box-shadow: 0 0 0 2px #434375;
        object-fit: cover;
    }
    .profile-photo-preview img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    input[type="file"] {
        display: block;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 8px;
        width: 100%;
        background-color: #f9f9f9;
    }
</style>

<div class="container editor-container">
    <div class="bg-white p-8 rounded-xl shadow-2xl border-t-8 border-primary">
        <h1 class="text-3xl font-bold text-gray-900 mb-6">Edit Your Provider Profile</h1>
        <p class="text-gray-600 mb-6">Update your professional details. This information will be displayed publicly.</p>

        <form action="/provider/profile" method="POST" id="profileUpdateForm">
            
            <!-- Hidden Input for Base64 Image Data -->
            <input type="hidden" name="profilePictureUrl" id="base64ImageOutput" value="<%= provider.profilePictureUrl || '' %>">

            <!-- Profile Picture Section -->
            <div class="mb-8 p-4 bg-indigo-50 rounded-lg text-center border border-indigo-200">
                <h2 class="text-xl font-semibold mb-3 text-indigo-800">Profile Picture</h2>
                
                <div class="profile-photo-preview mx-auto" id="profileImagePreview">
                    <% 
                        let finalProfileUrl = provider.profilePictureUrl;
                        if (finalProfileUrl && finalProfileUrl.length > 0 && !finalProfileUrl.startsWith('data:image')) {
                            finalProfileUrl = `data:image/jpeg;base64,${finalProfileUrl}`;
                        }
                    %>
                    <% if (finalProfileUrl && finalProfileUrl.startsWith('data:image')) { %>
                        <img id="image-preview" src="<%= finalProfileUrl %>" alt="Current Profile Picture">
                    <% } else { %>
                        <i id="image-placeholder" class="fas fa-user-circle"></i>
                    <% } %>
                </div>

                <input type="file" id="profilePictureInput" accept="image/*" class="mb-2">
                <p class="text-sm text-gray-500">Max file size 5MB. Must be a square image for best results.</p>
            </div>

            <!-- Profile Details -->
            <div class="grid md:grid-cols-2 gap-6 mb-6">
                <div class="form-group">
                    <label for="name" class="block text-sm font-medium text-gray-700 mb-1">Business/Personal Name</label>
                    <input type="text" id="name" name="name" value="<%= provider.name %>" required class="w-full border-gray-300 rounded-lg p-3">
                </div>
                <div class="form-group">
                    <label for="category" class="block text-sm font-medium text-gray-700 mb-1">Service Category</label>
                    <select id="category" name="category" required class="w-full border-gray-300 rounded-lg p-3">
                        <% ['Driver', 'Plumbing', 'Electrician', 'Gardening', 'Cleaning'].forEach(cat => { %>
                            <option value="<%= cat %>" <%= provider.category === cat ? 'selected' : '' %>><%= cat %></option>
                        <% }) %>
                    </select>
                </div>
            </div>

            <div class="form-group mb-6">
                <label for="contactInfo" class="block text-sm font-medium text-gray-700 mb-1">Public Contact Info (Phone/Email)</label>
                <input type="text" id="contactInfo" name="contactInfo" value="<%= provider.contactInfo || '' %>" class="w-full border-gray-300 rounded-lg p-3" placeholder="e.g., +1 555-1234 or booking@example.com">
            </div>

            <div class="form-group mb-8">
                <label for="description" class="block text-sm font-medium text-gray-700 mb-1">Detailed Description/Bio</label>
                <textarea id="description" name="description" rows="5" class="w-full border-gray-300 rounded-lg p-3" placeholder="Tell clients about your experience, certifications, and services offered."><%= provider.description || '' %></textarea>
            </div>

            <button type="submit" class="w-full btn-primary text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:shadow-xl transition">
                Save Profile Changes
            </button>
        </form>

        <div class="mt-6 text-center">
            <a href="/provider/dashboard" class="text-primary hover:underline font-semibold">
                <i class="fas fa-arrow-left mr-1"></i> Back to Dashboard
            </a>
        </div>
    </div>
</div>

<script>
    // === Profile Picture to Base64 Logic ===
    const fileInput = document.getElementById('profilePictureInput');
    const base64Output = document.getElementById('base64ImageOutput');
    const imagePreviewContainer = document.getElementById('profileImagePreview');

    fileInput.addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (!file) return;

        // Check file size (max 5MB)
        if (file.size > 5 * 1024 * 1024) {
            alert('File is too large. Maximum size is 5MB.');
            fileInput.value = ''; // Clear the input
            return;
        }

        const reader = new FileReader();

        reader.onload = function(e) {
            // The result includes the mime type (e.g., "data:image/jpeg;base64,...")
            const base64Data = e.target.result; 
            
            // Store the full Base64 string in the hidden input
            base64Output.value = base64Data; 
            
            // Update preview
            imagePreviewContainer.innerHTML = `<img src="${base64Data}" alt="New Profile Picture">`;
        };

        reader.onerror = function(error) {
            console.error('Error reading file:', error);
            alert('Could not read the file.');
        };

        reader.readAsDataURL(file);
    });
</script>

<%- include('./partials/foot') %>
